<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.css" rel="stylesheet" />
		<link rel="stylesheet" href="css/common.css">
		<link rel="stylesheet" href="css/search.css">
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">垃圾分类</h1>
		</header>
		<section>
			<h2>搜索匹配</h2>
			<div class="search-input">
					<form action="" onsubmit="return false" id="search">
						<input type="search" placeholder="请输入关键字" autofocus="autofocus"  id="searchInput"  />
					</form>
			</div>
		</section>
		<section>
			<div class="hot">
				<h3>热门搜索</h3>
				<ul id="hotList"></ul>
			</div>
			
			<div class="history">
				<h3>搜索历史</h3>
				<ul class="mui-table-view" id="historyList"></ul>
			</div>
			
		</section>
		
		<script src="js/mui.js"></script>
		<script src='js/flexible.js'></script>
		<script type="text/javascript">
			mui.init()
			mui.plusReady(function () {
			    var storage = localStorage;
					var sli = '';
					
					fGetStorage();
					
					mui.ajax('http://apis.juhe.cn/rubbish/hotSearch',{
						data:{
							key:'dfe7a5dc90a9be32d35d15d5a06eb619'
						},
						success:(data) => {
							// console.log(JSON.stringify(data.result))
							let result = data.result;
							mui.each(result,(index,item) => {
								mui('#hotList')[0].innerHTML +=`
								<li data-title='${item.itemName}'>${item.itemName}</li>
								`
							})
						}
						})
						
					// 热门搜索
					mui('#hotList').on('tap','li',function(){
						// console.log(this)
						let title = this.getAttribute('data-title');
						
						fToDetail(title)
						fSetStorage(title);
						fGetStorage();
					})
					
					// 搜索
					mui('.search-input').on('keypress','#search',function(e){
						var keyCode = e.keyCode;
						var val = document.querySelector('#searchInput').value;
						if(keyCode == 13){
							fToDetail(val);
							fSetStorage(val);
							fGetStorage();
							
							// 收起键盘
							document.activeElement.blur()
						}
					})
					
					// 点击空白处收起键盘
					window.addEventListener('touchstart',function(){
						document.activeElement.blur()
					},false)
					
					// 跳转详情
					function fToDetail(value){
						mui.openWindow({
							url:'detail.html',
							id:'detail',
							extras:{
								title:encodeURI(value)
							},
							waiting:{
								title:'玩命加载中...'
							}
						})
					}
					
					function fGetStorage(){
						sli = '';
						if(!storage.getItem('history')){
							storage.setItem('history','[]')
						}
						var arr = JSON.parse(storage.getItem('history'));
						
						mui.each(arr,function(index,item){
							sli += `
								<li class="mui-table-view-cell" data-title='${item}'>
								        <a class="mui-navigate-right"><p>${item}</p></a>
								    </li>
							`
						})
						
						mui('#historyList')[0].innerHTML = sli
					}
					
					function fSetStorage(val){
						var arr = JSON.parse(storage.getItem('history'));
						var arrFilter = arr.filter(item => item.indexOf(val) < 0);
						arrFilter.unshift(val);
						storage.setItem('history',JSON.stringify(arrFilter))
					}
					
					// 点击历史跳转
						
					mui('#historyList').on('tap','li'),function(){
						let title = this.getAttribute('data-title');
						fToDetail(title)
					}
					
					
			})
		</script>
	</body>

</html>
